{% extends "base.html" %}

{% block content %}
<div class="bg-gradient-to-b from-gray-50 to-white min-h-screen">
    <!-- Back Navigation -->
    <div class="bg-white border-b border-gray-100 sticky top-20 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center">
            <a href="/branches/{{ room.branch_id }}"
                class="flex items-center text-gray-700 hover:text-primary transition-colors">
                <i class="ri-arrow-left-line text-xl mr-2"></i>
                <span>지점으로 돌아가기</span>
            </a>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Image Gallery Section -->
            <div class="lg:col-span-3">
                <div class="sticky top-32"
                    x-data="{ currentImage: 0, images: [{% for img in room.images %}{'id': {{ img.id }}, 'url': '{{ img.image_url }}'}{% if not loop.last %},{% endif %}{% endfor %}] }">
                    <!-- Main Image -->
                    <div class="relative aspect-[4/3] rounded-2xl overflow-hidden bg-gray-100 shadow-2xl mb-4">
                        <template x-if="images.length > 0">
                            <div class="relative w-full h-full">
                                <img :src="images[currentImage].url"
                                    :alt="'{{ room.name }} - Image ' + (currentImage + 1)"
                                    class="w-full h-full object-cover">

                                <!-- Image Counter Badge -->
                                <div
                                    class="absolute top-4 right-4 bg-black/60 backdrop-blur-sm text-white px-3 py-1.5 rounded-full text-sm font-medium">
                                    <span x-text="currentImage + 1"></span> / <span x-text="images.length"></span>
                                </div>
                            </div>
                        </template>
                        <template x-if="images.length === 0">
                            <div class="w-full h-full flex items-center justify-center">
                                <div class="text-center">
                                    <i class="ri-image-line text-6xl text-gray-300 mb-3"></i>
                                    <p class="text-gray-400 font-medium">등록된 이미지가 없습니다</p>
                                </div>
                            </div>
                        </template>

                        <!-- Navigation Arrows -->
                        <template x-if="images.length > 1">
                            <div>
                                <button @click="currentImage = (currentImage - 1 + images.length) % images.length"
                                    class="absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 bg-white/90 hover:bg-white rounded-full shadow-lg flex items-center justify-center transition-all hover:scale-110">
                                    <i class="ri-arrow-left-s-line text-2xl text-gray-800"></i>
                                </button>
                                <button @click="currentImage = (currentImage + 1) % images.length"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 bg-white/90 hover:bg-white rounded-full shadow-lg flex items-center justify-center transition-all hover:scale-110">
                                    <i class="ri-arrow-right-s-line text-2xl text-gray-800"></i>
                                </button>
                            </div>
                        </template>
                    </div>

                    <!-- Thumbnail Gallery -->
                    <template x-if="images.length > 1">
                        <div class="grid grid-cols-4 gap-3">
                            <template x-for="(img, index) in images" :key="img.id">
                                <button @click="currentImage = index"
                                    :class="currentImage === index ? 'ring-2 ring-primary ring-offset-2' : 'ring-1 ring-gray-200 hover:ring-gray-300'"
                                    class="aspect-square rounded-lg overflow-hidden transition-all">
                                    <img :src="img.url" :alt="'{{ room.name }} thumbnail ' + (index + 1)"
                                        class="w-full h-full object-cover">
                                </button>
                            </template>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Room Info Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-lg p-6 lg:p-8 sticky top-32">
                    <!-- Room Title -->
                    <div class="mb-6">
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ room.name }}</h1>
                        <div class="flex items-center gap-2">
                            {% if room.status == 'available' %}
                            <span
                                class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                <i class="ri-checkbox-circle-line mr-1"></i>
                                계약가능
                            </span>
                            {% elif room.status == 'reserved' %}
                            <span
                                class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                <i class="ri-time-line mr-1"></i>
                                검토중
                            </span>
                            {% else %}
                            <span
                                class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                                <i class="ri-close-circle-line mr-1"></i>
                                계약완료
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Price -->
                    <div class="mb-6 pb-6 border-b border-gray-100">
                        <div class="flex items-baseline gap-2">
                            <span class="text-4xl font-bold text-primary">₩{{ "{:,}".format(room.price) }}</span>
                            <span class="text-lg text-gray-500">/월</span>
                        </div>
                        <div class="mt-2 text-sm text-gray-500">
                            보증금: <span class="font-medium text-gray-700">₩{{ "{:,}".format(room.deposit or 0) }}</span>
                        </div>
                    </div>

                    <!-- Description -->
                    {% if room.description %}
                    <div class="mb-6 pb-6 border-b border-gray-100">
                        <h3 class="text-sm font-semibold text-gray-900 mb-2 uppercase tracking-wide">설명</h3>
                        <p class="text-gray-600 leading-relaxed">{{ room.description }}</p>
                    </div>
                    {% endif %}

                    <!-- Room Details -->
                    <div class="mb-6 pb-6 border-b border-gray-100">
                        <h3 class="text-sm font-semibold text-gray-900 mb-4 uppercase tracking-wide">상세 정보</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600 flex items-center">
                                    <i class="ri-building-line mr-2 text-gray-400"></i>
                                    층수
                                </span>
                                <span class="font-medium text-gray-900">{{ room.floor or '1F' }}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600 flex items-center">
                                    <i class="ri-ruler-line mr-2 text-gray-400"></i>
                                    면적
                                </span>
                                <span class="font-medium text-gray-900">{{ room.area or '-' }}㎡</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600 flex items-center">
                                    <i class="ri-wallet-3-line mr-2 text-gray-400"></i>
                                    보증금
                                </span>
                                <span class="font-medium text-gray-900">₩{{ "{:,}".format(room.deposit or 0) }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Contract Form -->
                    {% if room.status == 'available' %}
                    <div x-data="contractForm()">
                        <form class="space-y-4" @submit.prevent="applyItem()">
                            <div>
                                <label for="start-date" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="ri-calendar-line mr-1"></i>
                                    입주 희망일
                                </label>
                                <input type="date" id="start-date" name="start-date" x-model="startDate" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                            </div>

                            <div>
                                <label for="months" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="ri-time-line mr-1"></i>
                                    계약 기간
                                </label>
                                <select id="months" name="months" x-model="months"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                                    <option value="1">1개월</option>
                                    <option value="2">2개월</option>
                                    <option value="3">3개월</option>
                                    <option value="6">6개월</option>
                                    <option value="12">12개월</option>
                                </select>
                            </div>

                            <!-- Monthly Rent Model Breakdown -->
                            <div class="bg-gray-50 rounded-xl p-5 border border-gray-100 space-y-4">
                                <!-- Initial Payment -->
                                <div class="flex items-center justify-between pb-3 border-b border-gray-200/60">
                                    <div>
                                        <span class="text-sm font-semibold text-gray-900">첫 달 결제 금액</span>
                                        <p class="text-[10px] text-gray-400 mt-0.5">(보증금 + 1회차 임대료)</p>
                                    </div>
                                    <div class="text-xl font-bold text-primary">
                                        ₩<span
                                            x-text="({{ room.price }} + {{ room.deposit or 0 }}).toLocaleString()"></span>
                                    </div>
                                </div>

                                <!-- Monthly Ongoing -->
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="text-sm font-medium text-gray-700">이후 월 납부액</span>
                                        <p class="text-[10px] text-gray-400 mt-0.5">(2회차부터 종료일차까지)</p>
                                    </div>
                                    <div class="text-lg font-semibold text-gray-800">
                                        ₩{{ "{:,}".format(room.price) }}
                                    </div>
                                </div>

                                <!-- Total Summary (Subtle) -->
                                <div class="pt-2 flex justify-end">
                                    <span class="text-[11px] text-gray-400">
                                        총 계약 기간: <span x-text="months"></span>개월 |
                                        총액: ₩<span
                                            x-text="(months * {{ room.price }} + {{ room.deposit or 0 }}).toLocaleString()"></span>
                                    </span>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="space-y-3 pt-2">
                                <button type="submit" :disabled="submitting"
                                    class="w-full bg-primary text-white py-4 rounded-xl font-semibold text-lg hover:bg-primary/90 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span x-show="!submitting"><i class="ri-file-text-line mr-2"></i>계약 신청하기</span>
                                    <span x-show="submitting"><i class="ri-loader-4-line animate-spin mr-2"></i>처리
                                        중...</span>
                                </button>
                                <button type="button" @click="openInquiry()"
                                    class="w-full bg-white text-gray-700 py-3 rounded-xl font-medium border-2 border-gray-200 hover:border-primary hover:text-primary transition-all">
                                    <i class="ri-customer-service-line mr-2"></i>
                                    문의하기
                                </button>
                            </div>
                            <p class="text-xs text-center text-gray-500 mt-3">
                                <i class="ri-information-line mr-1"></i>
                                계약 신청 및 문의는 로그인이 필요합니다
                            </p>
                        </form>

                        <!-- Inquiry Modal -->
                        <div x-show="showInquiryModal" class="fixed inset-0 z-[100] overflow-y-auto" x-cloak
                            x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
                            x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
                            x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
                            <div
                                class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                                <div class="fixed inset-0 transition-opacity bg-gray-900/60 backdrop-blur-sm"
                                    @click="showInquiryModal = false"></div>

                                <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

                                <div class="inline-block px-4 pt-5 pb-4 overflow-hidden text-left align-bottom transition-all transform bg-white shadow-2xl rounded-3xl sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-8"
                                    x-transition:enter="transition ease-out duration-300"
                                    x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                                    x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                                    x-transition:leave="transition ease-in duration-200"
                                    x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                                    x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">

                                    <div class="flex items-center justify-between mb-6">
                                        <h3 class="text-2xl font-bold text-gray-900">문의하기</h3>
                                        <button @click="showInquiryModal = false"
                                            class="text-gray-400 hover:text-gray-600 transition-colors">
                                            <i class="ri-close-line text-2xl"></i>
                                        </button>
                                    </div>

                                    <div class="mb-6 bg-primary/5 p-4 rounded-2xl flex items-start">
                                        <i class="ri-information-line text-primary text-xl mr-3 mt-0.5"></i>
                                        <p class="text-sm text-gray-600 leading-relaxed">
                                            <span class="font-bold text-primary">{{ room.branch.name }} - {{ room.name
                                                }}</span>에 대해 궁금한 점을 남겨주세요.
                                            담당자가 확인 후 마이페이지와 연락처로 답변해 드립니다.
                                        </p>
                                    </div>

                                    <form @submit.prevent="submitInquiry()" class="space-y-5">
                                        <div>
                                            <label for="inquiry-message"
                                                class="block text-sm font-bold text-gray-700 mb-2 pl-1">상세 문의 내용</label>
                                            <textarea id="inquiry-message" x-model="inquiryMessage" rows="5" required
                                                placeholder="예: 실사 확인이 가능한 날짜를 알고 싶습니다. / 주차 공간이 넉넉한가요?"
                                                class="w-full px-5 py-4 border border-gray-200 rounded-2xl focus:ring-4 focus:ring-primary/10 focus:border-primary transition-all resize-none text-sm"></textarea>
                                        </div>

                                        <button type="submit" :disabled="submittingInquiry"
                                            class="w-full bg-primary text-white py-4 rounded-2xl font-bold text-lg hover:bg-primary/90 transition-all shadow-xl shadow-primary/20 disabled:opacity-50">
                                            <span x-show="!submittingInquiry">문의 내용 보내기</span>
                                            <span x-show="submittingInquiry" class="flex items-center justify-center">
                                                <i class="ri-loader-4-line animate-spin mr-2"></i> 전송 중...
                                            </span>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="ri-close-circle-line text-3xl text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">현재 계약 불가</h3>
                        <p class="text-gray-500 mb-4">이 방은 현재 계약이 불가능합니다</p>
                        <button type="button"
                            class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-all">
                            <i class="ri-notification-line mr-2"></i>
                            알림 받기
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function contractForm() {
        return {
            months: 1,
            startDate: new Date().toISOString().split('T')[0],
            submitting: false,

            // Inquiry Modal State
            showInquiryModal: false,
            inquiryMessage: '',
            submittingInquiry: false,

            async applyItem() {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.showAlert('로그인 필요', '계약 신청을 위해 로그인이 필요합니다.', 'warning', () => {
                        window.location.href = `/login?next=${encodeURIComponent(window.location.pathname)}`;
                    });
                    return;
                }

                if (!this.startDate) {
                    window.showAlert('알림', '입주 희망일을 선택해주세요.', 'warning');
                    return;
                }

                this.submitting = true;
                try {
                    const response = await fetch('/api/contracts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            room_id: {{ room.id }},
                        start_date: this.startDate,
                        months: parseInt(this.months)
                        })
            });

            if(response.ok) {
            window.showAlert('신청 완료', '계약 신청이 완료되었습니다. 담당자 확인 후 연락드리겠습니다.', 'success', () => {
                window.location.href = '/my/room';
            });
        } else {
            const data = await response.json();
            window.showAlert('신청 실패', data.message || '계약 신청 중 오류가 발생했습니다.', 'error');
            if (response.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/login';
            }
        }
    } catch (error) {
        console.error('Error applying for contract:', error);
        window.showAlert('오류', '서버와의 통신 중 오류가 발생했습니다.', 'error');
    } finally {
        this.submitting = false;
    }
            },

    openInquiry() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.showAlert('로그인 필요', '문의를 위해 로그인이 필요합니다.', 'warning', () => {
                window.location.href = `/login?next=${encodeURIComponent(window.location.pathname)}`;
            });
            return;
        }
        this.showInquiryModal = true;
    },

            async submitInquiry() {
        if (!this.inquiryMessage.trim()) return;

        const token = localStorage.getItem('token');
        this.submittingInquiry = true;

        try {
            const response = await fetch('/api/requests', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    type: 'inquiry',
                    details: {
                        message: this.inquiryMessage,
                        room_name: '{{ room.branch.name }} - {{ room.name }}'
                    }
                })
            });

            if (response.ok) {
                window.showAlert('문의 완료', '문의가 성공적으로 전달되었습니다.', 'success');
                this.showInquiryModal = false;
                this.inquiryMessage = '';
            } else {
                window.showAlert('전송 실패', '문의 전송 중 오류가 발생했습니다.', 'error');
            }
        } catch (error) {
            console.error('Error submitting inquiry:', error);
            window.showAlert('오류', '서버와의 통신 중 오류가 발생했습니다.', 'error');
        } finally {
            this.submittingInquiry = false;
        }
    }
        }
    }
</script>
<style>
    [x-cloak] {
        display: none !important;
    }
</style>
{% endblock %}