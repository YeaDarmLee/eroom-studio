<!-- Public Floor Plan Component -->
<!-- This replaces the SVG-based floor plan with real admin-configured data -->

<style>
    .public-floor-plan-container {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        background-color: #f9fafb;
        overflow: visible;
    }

    .public-floor-plan-wrapper {
        position: relative;
        width: 100%;
        max-width: 860px;
        /* Limit max width to fit better on screen */
        margin: 0 auto;
        /* Center the floor plan */
        aspect-ratio: 4 / 3;
        overflow: hidden;
        border-radius: 0.75rem;
        background-color: #f8fafc;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .public-floor-plan-container.no-image {
        background-color: #e5e7eb;
        background-image: none;
    }

    .public-floor-plan-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        pointer-events: none;
    }

    .public-room-box {
        position: absolute;
        background-color: rgba(59, 130, 246, 0.25);
        border: 2px solid #3b82f6;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 0.5rem;
    }

    .public-room-box:hover {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        background-color: rgba(59, 130, 246, 0.4);
        transform: translateY(-2px);
        z-index: 100;
    }

    .public-room-box.available {
        background-color: rgba(39, 174, 96, 0.25);
        border-color: #27AE60;
    }

    .public-room-box.available:hover {
        background-color: rgba(39, 174, 96, 0.35);
    }

    .public-room-box.occupied {
        background-color: rgba(127, 140, 141, 0.25);
        border-color: #7F8C8D;
        cursor: not-allowed;
    }

    .public-room-box.occupied:hover {
        background-color: rgba(127, 140, 141, 0.4);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transform: translateY(-2px);
        z-index: 100;
    }

    .public-room-box.time-based {
        background-color: rgba(241, 196, 15, 0.25);
        border-color: #F1C40F;
    }

    .public-room-box.time-based:hover {
        background-color: rgba(241, 196, 15, 0.4);
    }

    .public-room-box.manager {
        background-color: rgba(155, 89, 182, 0.25);
        border-color: #9B59B6;
        cursor: not-allowed;
    }

    .public-room-box.manager:hover {
        background-color: rgba(155, 89, 182, 0.4);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transform: translateY(-2px);
        z-index: 100;
    }

    .public-room-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #1e40af;
        pointer-events: none;
        user-select: none;
    }

    .public-room-box.available .public-room-label {
        color: #27AE60;
    }

    .public-room-box.time-based .public-room-label {
        color: #D68910;
    }

    .public-room-box.manager .public-room-label {
        color: #8E44AD;
    }

    .public-room-box.occupied .public-room-label {
        color: #7F8C8D;
    }

    .public-floor-tab {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        transition: all 0.2s;
        cursor: pointer;
    }

    .public-floor-tab.active {
        background-color: #3b82f6;
        color: white;
    }

    .public-floor-tab:not(.active) {
        background-color: #e5e7eb;
        color: #6b7280;
    }

    .public-floor-tab:not(.active):hover {
        background-color: #d1d5db;
    }



    .room-tooltip {
        position: fixed;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.75rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        white-space: nowrap;
        z-index: 9999;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s, transform 0.2s;
    }

    .public-room-box:hover .room-tooltip {
        opacity: 1;
        transform: translate(-50%, -8px);
    }



    .room-tooltip-title {
        font-weight: 600;
        font-size: 0.875rem;
        color: #111827;
        margin-bottom: 0.5rem;
    }

    .room-tooltip-info {
        font-size: 0.75rem;
        color: #6b7280;
        line-height: 1.5;
    }

    .room-tooltip-status {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        margin-top: 0.5rem;
    }

    .room-tooltip-status.available {
        background-color: #dcfce7;
        color: #166534;
    }

    .room-tooltip-status.occupied {
        background-color: #f3f4f6;
        color: #6b7280;
    }

    .public-room-box.occupied .public-room-label {
        color: #7F8C8D;
    }
</style>

<!-- Floor Plan Section -->
<div class="mb-16" id="floor-plan-section" x-data="{
    selectedFloor: null,
    floorPlans: {},
    roomsByFloor: {},
    branchData: null,
    
    async init() {
        await this.loadBranchData();
    },
    
    async loadBranchData() {
        try {
            const branchId = {{ branch.id }};
            const response = await fetch(`/api/public/branches/${branchId}`);
            if (response.ok) {
                this.branchData = await response.json();
                this.roomsByFloor = this.branchData.rooms_by_floor || {};
                this.floorPlans = this.branchData.floor_plans || {};
                
                // Set default floor: Try '1F' first, then fallback to first available floor
                const availableFloors = Object.keys(this.floorPlans).length > 0 
                    ? Object.keys(this.floorPlans) 
                    : Object.keys(this.roomsByFloor);
                
                if (availableFloors.includes('1F')) {
                    this.selectedFloor = '1F';
                } else if (availableFloors.length > 0) {
                    this.selectedFloor = availableFloors[0];
                }
            }
        } catch (error) {
            console.error('Error loading branch data:', error);
        }
    },
    
    selectFloor(floor) {
        this.selectedFloor = floor;
    },
    
    getRoomStatusClass(status) {
        if (status === 'available') return 'available';
        if (status === 'occupied') return 'occupied';
        return '';
    },
    
    viewRoomDetail(roomId) {
        window.location.href = `/rooms/${roomId}`;
    }
}">
    <h2 class="text-2xl font-bold mb-4">연습실 배치도</h2>

    <!-- Check if any rooms with positions exist -->
    <template x-if="Object.keys(roomsByFloor).length === 0">
        <div class="bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 p-12 text-center">
            <i class="ri-image-line text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 font-medium mb-2">배치도가 준비 중입니다</p>
            <p class="text-gray-400 text-sm">아래 룸 목록에서 연습실을 확인하실 수 있습니다</p>
        </div>
    </template>

    <!-- Floor Plan View -->
    <template x-if="Object.keys(roomsByFloor).length > 0">
        <div class="space-y-6">
            <!-- Status Information (Moved to Top) -->
            <div
                class="bg-white rounded-xl border border-gray-100 p-3 flex flex-wrap items-center justify-between gap-3">
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-[#27AE60]"></div>
                        <span class="text-sm font-medium text-gray-700">월간 계약 가능</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-[#F1C40F]"></div>
                        <span class="text-sm font-medium text-gray-700">시간제 예약 가능</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-[#9B59B6]"></div>
                        <span class="text-sm font-medium text-gray-700">총무방</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded bg-[#7F8C8D]"></div>
                        <span class="text-sm font-medium text-gray-700">계약 완료</span>
                    </div>
                </div>

                <div class="flex items-center gap-4 text-sm">
                    <div class="bg-gray-50 px-3 py-1.5 rounded-lg flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500 font-medium"><span x-text="selectedFloor"></span> 정보:</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500 text-xs">총</span>
                            <span class="font-bold text-gray-900"
                                x-text="(roomsByFloor[selectedFloor] || []).length + '개'"></span>
                        </div>
                        <div class="flex items-center gap-2 border-l border-gray-200 pl-4">
                            <span class="text-gray-500 text-xs text-green-600">가능</span>
                            <span class="font-bold text-green-600"
                                x-text="(roomsByFloor[selectedFloor] || []).filter(r => r.status === 'available').length + '개'"></span>
                        </div>
                        <div class="flex items-center gap-2 border-l border-gray-200 pl-4">
                            <span class="text-gray-500 text-xs">완료</span>
                            <span class="font-bold text-gray-400"
                                x-text="(roomsByFloor[selectedFloor] || []).filter(r => r.status === 'occupied').length + '개'"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="relative bg-white rounded-xl border border-gray-100 p-4 shadow-sm">
                <!-- Floor Tabs -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <template x-for="(rooms, floor) in roomsByFloor" :key="floor">
                        <button @click="selectFloor(floor)" :class="selectedFloor === floor ? 'active' : ''"
                            class="public-floor-tab" x-text="floor">
                        </button>
                    </template>
                </div>

                <!-- Floor Plan Canvas -->
                <div class="public-floor-plan-wrapper py-16">
                    <div class="public-floor-plan-container" :class="{ 'no-image': !floorPlans[selectedFloor] }">
                        <!-- Floor Plan Background Image -->
                        <img x-show="floorPlans[selectedFloor]" :src="floorPlans[selectedFloor]"
                            class="public-floor-plan-image" alt="Floor Plan">

                        <!-- No Floor Plan Message (but rooms exist) -->
                        <div x-show="!floorPlans[selectedFloor] && (roomsByFloor[selectedFloor] || []).length > 0"
                            class="absolute top-4 left-4 bg-blue-50 border border-blue-200 rounded-lg px-4 py-2 text-sm text-blue-800 z-10">
                            <i class="ri-information-line mr-1"></i>
                            도면 이미지는 준비 중이며, 방 위치만 표시됩니다
                        </div>

                        <!-- Room Boxes -->
                        <template x-for="room in (roomsByFloor[selectedFloor] || [])" :key="room.id">
                            <div class="public-room-box group" :class="[
                                    getRoomStatusClass(room.status), 
                                    room.room_type === 'time_based' ? 'time-based' : '',
                                    room.room_type === 'manager' ? 'manager' : ''
                                ]"
                                :style="`left: ${room.position_x || 0}%; top: ${room.position_y || 0}%; width: ${room.width || 10}%; height: ${room.height || 10}%;`"
                                @click="(room.status !== 'occupied' && room.room_type !== 'manager') ? viewRoomDetail(room.id) : null">

                                <!-- Hover Tooltip (CSS 기반 - 간단한 방식) -->
                                <div class="fixed px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity duration-200 whitespace-nowrap shadow-xl"
                                    style="z-index: 9999;" :style="`
                                        left: 50%;
                                        ${(room.position_y || 0) < 50 ? 'top: 100%; margin-top: 10px;' : 'bottom: 100%; margin-bottom: 10px;'}
                                        transform: translateX(-50%);
                                    `">
                                    <div class="flex items-center justify-between gap-4 mb-0.5">
                                        <div class="font-bold" x-text="room.name"></div>
                                        <template x-if="room.room_type === 'time_based'">
                                            <span
                                                class="px-1 py-0.5 bg-yellow-400 text-yellow-950 text-[10px] rounded font-black leading-none">시간제</span>
                                        </template>
                                        <template x-if="room.room_type === 'manager'">
                                            <span
                                                class="px-1 py-0.5 bg-purple-500 text-white text-[10px] rounded font-black leading-none">총무방</span>
                                        </template>
                                    </div>
                                    <div class="text-[10px] opacity-70 mb-1"
                                        x-text="(room.floor.includes('층') ? room.floor : room.floor + '층') + ' | ' + (room.area || '-') + '㎡'">
                                    </div>

                                    <div class="flex items-center gap-1.5 mt-1 border-t border-white/10 pt-1">
                                        <span class="opacity-70"
                                            x-text="room.room_type === 'time_based' ? '시간당:' : '월 임대료:'"></span>
                                        <span class="font-bold text-yellow-300"
                                            x-text="'₩' + room.price.toLocaleString()"></span>
                                    </div>

                                    <div class="mt-1 flex items-center gap-1.5">
                                        <span class="opacity-70">상태:</span>
                                        <template x-if="room.room_type === 'manager'">
                                            <span class="text-purple-300">총무 상주 중</span>
                                        </template>
                                        <template x-if="room.room_type !== 'manager'">
                                            <span
                                                :class="room.status === 'available' ? 'text-green-300' : 'text-gray-300'"
                                                x-text="room.status === 'available' ? '✓ 예약 가능' : (room.status === 'occupied' ? '✕ 예약 완료' : '⏳ 검토 중')"></span>
                                        </template>
                                    </div>
                                </div>

                                <!-- Room Label -->
                                <div class="public-room-label">
                                    <div x-text="room.name"></div>
                                    <div class="text-xs opacity-75" x-text="'₩' + (room.price / 10000) + '만'"></div>
                                </div>
                            </div>
                        </template>

                        <!-- No Rooms Message -->
                        <div x-show="!roomsByFloor[selectedFloor] || roomsByFloor[selectedFloor].length === 0"
                            class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div class="text-center bg-white/90 p-6 rounded-lg">
                                <i class="ri-door-line text-4xl text-gray-300 mb-2"></i>
                                <p class="text-gray-500 font-medium">이 층에 등록된 방이 없습니다</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex">
                        <i class="ri-information-line text-blue-600 mr-3 mt-0.5"></i>
                        <div class="text-sm text-blue-800">
                            <p class="font-semibold mb-1">도면 사용 방법:</p>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>방 박스를 <strong>클릭</strong>하면 상세 정보를 확인할 수 있습니다</li>
                                <li><span class="text-green-600 font-semibold">초록색</span> 방은 월간 계약 가능 룸입니다</li>
                                <li><span class="text-yellow-600 font-semibold">노란색</span> 방은 시간제 예약 가능한 룸입니다</li>
                                <li><span class="text-purple-600 font-semibold">보라색</span> 방은 총무가 머무는 방입니다</li>
                                <li><span class="text-gray-600 font-semibold">회색</span> 방은 이미 계약된 방입니다</li>
                                <li x-show="!floorPlans[selectedFloor]" class="text-blue-600">도면 이미지는 준비 중이며, 방 위치는
                                    참고용입니다</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
</div>