{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8" x-data="loginPage()">
    <div class="sm:mx-auto sm:w-full sm:max-w-md">
        <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
            로그인
        </h2>
        <p class="mt-2 text-center text-sm text-gray-600">
            이룸 스튜디오에 오신 것을 환영합니다
        </p>
    </div>

    <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
        <div class="bg-white py-8 px-4 shadow-lg sm:rounded-xl sm:px-10">
            <!-- Login Method Buttons -->
            <div class="space-y-3">
                <!-- Kakao Mock Login -->
                <button @click="mockKakaoLogin()"
                    class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-black bg-[#FEE500] hover:bg-[#FEE500]/90 transition-all duration-300 hover:shadow-md">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
                    </svg>
                    카카오 로그인 (Mock)
                </button>

                <!-- Email Login Button -->
                <button @click="showEmailForm = !showEmailForm"
                    class="w-full flex justify-center items-center py-3 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-all duration-300 hover:shadow-md">
                    <i class="ri-mail-line mr-2 text-lg"></i>
                    이메일로 로그인
                    <i class="ml-auto text-lg transition-transform duration-300"
                        :class="showEmailForm ? 'ri-arrow-up-s-line' : 'ri-arrow-down-s-line'"></i>
                </button>
            </div>

            <!-- Email Login Form (Slide Down) -->
            <div x-show="showEmailForm" x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 transform -translate-y-2"
                x-transition:enter-end="opacity-100 transform translate-y-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 transform translate-y-0"
                x-transition:leave-end="opacity-0 transform -translate-y-2" class="mt-4 pt-4 border-t border-gray-200">

                <form @submit.prevent="handleEmailLogin()" class="space-y-4">
                    <!-- Error Message -->
                    <div x-show="errorMessage" x-transition class="p-3 bg-red-50 border border-red-200 rounded-md">
                        <p class="text-sm text-red-600" x-text="errorMessage"></p>
                    </div>

                    <!-- Email Input -->
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">이메일</label>
                        <input type="email" id="email" x-model="email" required
                            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-300 sm:text-sm"
                            placeholder="your@email.com">
                    </div>

                    <!-- Password Input -->
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">비밀번호</label>
                        <input type="password" id="password" x-model="password" required
                            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-300 sm:text-sm"
                            placeholder="••••••••">
                    </div>

                    <!-- Submit Button -->
                    <div>
                        <button type="submit" :disabled="loading"
                            class="w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-slate-800 hover:bg-slate-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!loading">로그인</span>
                            <span x-show="loading" class="flex items-center">
                                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                로그인 중...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function loginPage() {
        return {
            showEmailForm: false,
            email: '',
            password: '',
            errorMessage: '',
            loading: false,

            // Kakao Mock Login
            mockKakaoLogin() {
                fetch('/api/auth/mock-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        localStorage.setItem('token', data.access_token);
                        window.location.href = '/my/room';
                    })
                    .catch(error => {
                        console.error('Login error:', error);
                        alert('로그인 실패');
                    });
            },

            // Email Login - Auto-detect admin/user
            handleEmailLogin() {
                this.errorMessage = '';
                this.loading = true;

                fetch('/api/auth/email-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: this.email,
                        password: this.password
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => Promise.reject(err));
                        }
                        return response.json();
                    })
                    .then(data => {
                        localStorage.setItem('token', data.access_token);

                        // Auto-redirect based on user role
                        if (data.user.role === 'admin') {
                            window.location.href = '/admin';
                        } else {
                            window.location.href = '/my/room';
                        }
                    })
                    .catch(error => {
                        console.error('Email login error:', error);
                        this.errorMessage = error.message || '이메일 또는 비밀번호가 올바르지 않습니다.';
                    })
                    .finally(() => {
                        this.loading = false;
                    });
            }
        }
    }
</script>
{% endblock %}