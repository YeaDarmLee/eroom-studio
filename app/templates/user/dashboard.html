{% extends "base.html" %}

{% block content %}
<div class="bg-gray-50/50 min-h-screen pb-20" x-data="dashboardData()" x-init="init()">
    <div class="max-w-6xl mx-auto pt-10 px-4 sm:px-6 lg:px-8">
        <!-- Dashboard Header -->
        <div class="flex flex-col md:flex-row md:items-end justify-between mb-10 gap-6">
            <div>
                <nav class="flex mb-4" aria-label="Breadcrumb">
                    <ol class="flex items-center space-x-2 text-xs text-gray-400 font-medium">
                        <li><a href="/" class="hover:text-primary transition-colors">홈</a></li>
                        <li><i class="ri-arrow-right-s-line"></i></li>
                        <li class="text-gray-600">마이페이지</li>
                    </ol>
                </nav>
                <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">마이페이지</h1>
                <p class="mt-2 text-gray-500">환영합니다, <span class="text-gray-900 font-semibold"
                        x-text="userName || '사용자'"></span>님!</p>
            </div>
        </div>

        <!-- Dashboard Loading State -->
        <div x-show="loading" class="flex flex-col items-center justify-center py-32 text-gray-400">
            <div class="relative">
                <div class="w-12 h-12 border-4 border-primary/20 border-t-primary rounded-full animate-spin"></div>
            </div>
            <p class="mt-4 font-medium">정보를 불러오는 중입니다...</p>
        </div>

        <div x-show="!loading" x-cloak class="grid grid-cols-1 lg:grid-cols-4 gap-8 items-start">
            <!-- Sidebar Navigation -->
            <div class="lg:col-span-1 space-y-2 sticky top-24">
                <button @click="activeTab = 'dashboard'"
                    :class="activeTab === 'dashboard' ? 'bg-primary text-white shadow-lg shadow-primary/20' : 'bg-white text-gray-600 hover:bg-gray-50 border border-gray-100'"
                    class="w-full text-left px-5 py-4 rounded-2xl font-bold text-sm transition-all flex items-center justify-between group">
                    <span class="flex items-center">
                        <i class="ri-dashboard-3-line mr-3 text-lg"
                            :class="activeTab === 'dashboard' ? 'text-white' : 'text-gray-400 group-hover:text-primary'"></i>
                        내 계약 현황
                    </span>
                    <i x-show="activeTab === 'dashboard'" class="ri-arrow-right-s-line"></i>
                </button>
                <button @click="activeTab = 'requests'"
                    :class="activeTab === 'requests' ? 'bg-primary text-white shadow-lg shadow-primary/20' : 'bg-white text-gray-600 hover:bg-gray-50 border border-gray-100'"
                    class="w-full text-left px-5 py-4 rounded-2xl font-bold text-sm transition-all flex items-center justify-between group">
                    <span class="flex items-center">
                        <i class="ri-tools-line mr-3 text-lg"
                            :class="activeTab === 'requests' ? 'text-white' : 'text-gray-400 group-hover:text-primary'"></i>
                        서비스 요청
                    </span>
                    <i x-show="activeTab === 'requests'" class="ri-arrow-right-s-line"></i>
                </button>
                <button @click="activeTab = 'inquiries'"
                    :class="activeTab === 'inquiries' ? 'bg-primary text-white shadow-lg shadow-primary/20' : 'bg-white text-gray-600 hover:bg-gray-50 border border-gray-100'"
                    class="w-full text-left px-5 py-4 rounded-2xl font-bold text-sm transition-all flex items-center justify-between group">
                    <span class="flex items-center">
                        <i class="ri-chat-1-line mr-3 text-lg"
                            :class="activeTab === 'inquiries' ? 'text-white' : 'text-gray-400 group-hover:text-primary'"></i>
                        문의 내역
                    </span>
                    <i x-show="activeTab === 'inquiries'" class="ri-arrow-right-s-line"></i>
                </button>
                <div class="pt-4 mt-4 border-t border-gray-100">
                    <button @click="activeTab = 'profile'"
                        :class="activeTab === 'profile' ? 'bg-primary text-white shadow-lg shadow-primary/20' : 'bg-white text-gray-600 hover:bg-gray-50 border border-gray-100'"
                        class="w-full text-left px-5 py-4 rounded-2xl font-bold text-sm transition-all flex items-center justify-between group">
                        <span class="flex items-center">
                            <i class="ri-user-settings-line mr-3 text-lg"
                                :class="activeTab === 'profile' ? 'text-white' : 'text-gray-400 group-hover:text-primary'"></i>
                            내 정보 관리
                        </span>
                        <i x-show="activeTab === 'profile'" class="ri-arrow-right-s-line"></i>
                    </button>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="lg:col-span-3">
                <!-- Dashboard / Overview Content -->
                <div x-show="activeTab === 'dashboard'"
                    class="space-y-8 animate-in fade-in slide-in-from-right-4 duration-500">

                    <!-- Contract Cards Grid -->
                    <template x-if="contracts.length > 0">
                        <div class="space-y-8">
                            <template x-for="contract in contracts" :key="contract.id">
                                <div
                                    class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden group hover:shadow-xl hover:shadow-gray-200/50 transition-all duration-300">
                                    <!-- Card Header -->
                                    <div
                                        class="px-8 py-6 border-b border-gray-50 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                        <div class="flex items-center bg-gray-50 rounded-2xl px-4 py-2 w-fit">
                                            <div
                                                class="w-10 h-10 bg-primary text-white rounded-xl flex items-center justify-center mr-4 shadow-md shadow-primary/20">
                                                <i class="ri-building-line text-xl"></i>
                                            </div>
                                            <div>
                                                <h3 class="text-sm text-gray-400 font-bold uppercase tracking-wider mb-0.5"
                                                    x-text="contract.room?.branch_name"></h3>
                                                <p class="text-xl font-extrabold text-gray-900"
                                                    x-text="contract.room?.name"></p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span
                                                class="px-3 py-1.5 rounded-lg text-[11px] font-bold border border-gray-400 bg-white text-gray-700 uppercase tracking-tight"
                                                x-text="contract.payment_method === 'card' ? '카드 결제' : '무통장 입금'">
                                            </span>
                                            <span :class="getStatusBadgeClass(contract.status)"
                                                class="px-5 py-2 rounded-xl text-xs font-bold flex items-center shadow-sm"
                                                x-text="translateStatus(contract.status)">
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Card Body Content -->
                                    <div class="p-8">
                                        <!-- Main Details Grid -->
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-y-8 gap-x-4 mb-10">
                                            <!-- Monthly/Default Contract -->
                                            <template x-if="contract.room?.room_type !== 'time_based'">
                                                <div
                                                    class="grid grid-cols-2 md:grid-cols-4 gap-y-8 gap-x-4 col-span-2 md:col-span-4">
                                                    <div class="space-y-2 border-l-2 border-gray-100 pl-4">
                                                        <p
                                                            class="text-[11px] font-bold text-gray-400 uppercase tracking-widest">
                                                            계약 시작일</p>
                                                        <p class="text-base font-extrabold text-gray-800"
                                                            x-text="formatDateShort(contract.start_date)"></p>
                                                    </div>
                                                    <div class="space-y-2 border-l-2 border-gray-100 pl-4">
                                                        <p
                                                            class="text-[11px] font-bold text-gray-400 uppercase tracking-widest">
                                                            계약 종료일</p>
                                                        <template x-if="contract.is_indefinite">
                                                            <p
                                                                class="text-sm font-black text-gray-500 bg-gray-100 px-2 py-1 rounded inline-block">
                                                                한달 전 통보</p>
                                                        </template>
                                                        <template x-if="!contract.is_indefinite">
                                                            <p class="text-base font-extrabold text-gray-800"
                                                                x-text="formatDateShort(contract.end_date)"></p>
                                                        </template>
                                                    </div>
                                                    <div class="space-y-2 border-l-2 border-gray-100 pl-4">
                                                        <p
                                                            class="text-[11px] font-bold text-gray-400 uppercase tracking-widest">
                                                            월 임대료</p>
                                                        <p class="text-base font-extrabold text-primary">₩<span
                                                                x-text="contract.price?.toLocaleString()"></span>
                                                        </p>
                                                    </div>
                                                    <div class="space-y-2 border-l-2 border-gray-100 pl-4">
                                                        <p
                                                            class="text-[11px] font-bold text-gray-400 uppercase tracking-widest">
                                                            보증금</p>
                                                        <p class="text-base font-extrabold text-gray-800">₩<span
                                                                x-text="contract.deposit?.toLocaleString()"></span>
                                                        </p>
                                                    </div>
                                                </div>
                                            </template>

                                            <!-- Time-based Contract -->
                                            <template x-if="contract.room?.room_type === 'time_based'">
                                                <div
                                                    class="grid grid-cols-2 md:grid-cols-4 gap-y-8 gap-x-4 col-span-2 md:col-span-4">
                                                    <div class="space-y-2 border-l-2 border-gray-100 pl-4">
                                                        <p
                                                            class="text-[11px] font-bold text-gray-400 uppercase tracking-widest">
                                                            예약 날짜</p>
                                                        <p class="text-base font-extrabold text-gray-800"
                                                            x-text="formatDateShort(contract.start_date)"></p>
                                                    </div>
                                                    <div class="space-y-2 border-l-2 border-gray-100 pl-4">
                                                        <p
                                                            class="text-[11px] font-bold text-gray-400 uppercase tracking-widest">
                                                            예약 시간</p>
                                                        <p class="text-base font-extrabold text-gray-800"><span
                                                                x-text="contract.start_time"></span> ~ <span
                                                                x-text="contract.end_time"></span></p>
                                                    </div>
                                                    <div class="space-y-2 border-l-2 border-gray-100 pl-4">
                                                        <p
                                                            class="text-[11px] font-bold text-gray-400 uppercase tracking-widest">
                                                            이용 금액</p>
                                                        <p class="text-base font-extrabold text-primary">₩<span
                                                                x-text="contract.price?.toLocaleString()"></span></p>
                                                    </div>
                                                    <div class="space-y-2 border-l-2 border-gray-100 pl-4">
                                                        <p
                                                            class="text-[11px] font-bold text-gray-400 uppercase tracking-widest">
                                                            신청 상태</p>
                                                        <p class="text-base font-extrabold text-gray-800"
                                                            x-text="translateStatus(contract.status)"></p>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>

                                        <!-- Payment & Discount Details -->
                                        <template x-if="contract.discount_details">
                                            <div class="mt-8 bg-blue-50/30 rounded-2xl p-6 border border-blue-100/50">
                                                <div class="flex items-center gap-2 mb-4">
                                                    <i class="ri-creative-commons-nc-line text-blue-500"></i>
                                                    <h4 class="text-sm font-bold text-gray-900">결제 및 할인 상세</h4>
                                                </div>
                                                <div class="space-y-3">
                                                    <div class="flex justify-between items-center text-sm">
                                                        <span class="text-gray-500">정상 임대료</span>
                                                        <span class="font-bold text-gray-900"
                                                            x-text="'₩' + contract.discount_details.base_price?.toLocaleString()"></span>
                                                    </div>
                                                    <template
                                                        x-if="contract.discount_details.monthly_promo_discount > 0">
                                                        <div class="flex justify-between items-center text-sm">
                                                            <span class="text-gray-500">장기 계약 할인</span>
                                                            <span class="font-bold text-green-600"
                                                                x-text="'- ₩' + contract.discount_details.monthly_promo_discount?.toLocaleString()"></span>
                                                        </div>
                                                    </template>
                                                    <template x-if="contract.discount_details.coupon_discount > 0">
                                                        <div class="flex justify-between items-center text-sm">
                                                            <span class="text-gray-500 flex items-center gap-1">
                                                                쿠폰 할인
                                                                <span
                                                                    class="text-[10px] bg-primary/10 text-primary px-1.5 py-0.5 rounded"
                                                                    x-text="contract.coupon_name"></span>
                                                            </span>
                                                            <span class="font-bold text-green-600"
                                                                x-text="'- ₩' + contract.discount_details.coupon_discount?.toLocaleString()"></span>
                                                        </div>
                                                    </template>
                                                    <template
                                                        x-if="contract.discount_details.proration_adjustment && contract.discount_details.proration_adjustment !== 0">
                                                        <div class="flex justify-between items-center text-sm">
                                                            <span class="text-gray-500">일할 계산 (입주 기산일 조정)</span>
                                                            <span class="font-bold"
                                                                :class="contract.discount_details.proration_adjustment > 0 ? 'text-blue-600' : 'text-green-600'"
                                                                x-text="(contract.discount_details.proration_adjustment > 0 ? '+ ₩' : '- ₩') + Math.abs(contract.discount_details.proration_adjustment).toLocaleString()"></span>
                                                        </div>
                                                    </template>
                                                    <div class="pt-3 border-t border-blue-100 space-y-2">
                                                        <!-- 첫 달 결제 금액 -->
                                                        <div
                                                            class="flex justify-between items-center bg-white/50 p-3 rounded-xl border border-blue-100/50">
                                                            <div>
                                                                <p class="text-sm font-black text-gray-900">첫 달 결제 금액
                                                                    (총계)</p>
                                                                <p
                                                                    class="text-[10px] text-gray-400 font-bold uppercase mt-0.5">
                                                                    보증금 임대료 포함</p>
                                                            </div>
                                                            <p class="text-xl font-black text-secondary"
                                                                x-text="'₩' + ((contract.discount_details.first_month_total || (contract.price + contract.deposit)) - (contract.deposit || 0)).toLocaleString() + ((contract.deposit || 0) > 0 ? ' + ₩' + (contract.deposit || 0).toLocaleString() : '')">
                                                            </p>
                                                        </div>
                                                        <!-- 이후 월 납부 금액 -->
                                                        <div
                                                            class="flex justify-between items-center bg-white/50 p-3 rounded-xl border border-blue-100/50">
                                                            <div>
                                                                <p class="text-sm font-black text-gray-900">이후 월 납부 금액
                                                                </p>
                                                                <p class="text-[10px] text-gray-400 font-bold uppercase mt-0.5"
                                                                    x-text="(contract.payment_method === 'card' ? '카드 결제' : '무통장 입금') + ' | 매월 ' + contract.payment_day + '일'">
                                                                </p>
                                                            </div>
                                                            <p class="text-xl font-black text-primary"
                                                                x-text="'₩' + contract.price?.toLocaleString()"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>

                                        <!-- Status-specific Alert / Actions -->
                                        <div class="mt-8">
                                            <!-- Requested Status Alert -->
                                            <template x-if="contract.status === 'requested'">
                                                <div
                                                    class="bg-amber-50 rounded-2xl p-6 flex items-start border border-amber-100/50 shadow-inner">
                                                    <div class="bg-white p-2 rounded-xl shadow-sm mr-4 mt-0.5">
                                                        <i class="ri-time-line text-amber-500 text-xl"></i>
                                                    </div>
                                                    <div class="text-sm">
                                                        <p class="font-extrabold text-amber-900 mb-1">계약 신청이 접수되어 검토
                                                            중입니다</p>
                                                        <p class="text-amber-800/80 leading-relaxed font-medium">담당자가 신청
                                                            내용을 확인한 후 1~2영업일 이내에 개별 연락을 드립니다. 잠시만 기다려 주세요.</p>
                                                    </div>
                                                </div>
                                            </template>

                                            <!-- Active Status Quick Actions -->
                                            <template x-if="contract.status === 'active'">
                                                <div class="space-y-5">
                                                    <div class="flex items-center justify-between">
                                                        <h4 class="text-sm font-bold text-gray-900 flex items-center">
                                                            <span
                                                                class="w-1.5 h-1.5 bg-primary rounded-full mr-2"></span>
                                                            룸 전용 서비스 이용하기
                                                        </h4>
                                                    </div>
                                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                        <button @click="openServiceModal('repair', contract.id)"
                                                            class="flex items-center p-4 rounded-2xl bg-white border border-gray-100 hover:border-primary hover:shadow-md transition-all group">
                                                            <div
                                                                class="w-10 h-10 rounded-xl bg-gray-50 flex items-center justify-center mr-3 group-hover:bg-primary/10 transition-colors">
                                                                <i
                                                                    class="ri-tools-line text-gray-400 group-hover:text-primary"></i>
                                                            </div>
                                                            <span
                                                                class="text-xs font-bold text-gray-700 group-hover:text-primary">시설수리</span>
                                                        </button>
                                                        <button @click="openServiceModal('supplies', contract.id)"
                                                            class="flex items-center p-4 rounded-2xl bg-white border border-gray-100 hover:border-primary hover:shadow-md transition-all group">
                                                            <div
                                                                class="w-10 h-10 rounded-xl bg-gray-50 flex items-center justify-center mr-3 group-hover:bg-primary/10 transition-colors">
                                                                <i
                                                                    class="ri-sparkling-2-line text-gray-400 group-hover:text-primary"></i>
                                                            </div>
                                                            <span
                                                                class="text-xs font-bold text-gray-700 group-hover:text-primary">비품/청소</span>
                                                        </button>
                                                        <button @click="openServiceModal('extension', contract.id)"
                                                            x-show="!contract.is_indefinite"
                                                            class="flex items-center p-4 rounded-2xl bg-white border border-gray-100 hover:border-primary hover:shadow-md transition-all group">
                                                            <div
                                                                class="w-10 h-10 rounded-xl bg-gray-50 flex items-center justify-center mr-3 group-hover:bg-primary/10 transition-colors">
                                                                <i
                                                                    class="ri-calendar-event-line text-gray-400 group-hover:text-primary"></i>
                                                            </div>
                                                            <span
                                                                class="text-xs font-bold text-gray-700 group-hover:text-primary">연장
                                                                신청</span>
                                                        </button>
                                                        <button @click="openServiceModal('termination', contract.id)"
                                                            class="flex items-center p-4 rounded-2xl bg-white border border-gray-100 hover:border-red-200 hover:shadow-md transition-all group">
                                                            <div
                                                                class="w-10 h-10 rounded-xl bg-gray-50 flex items-center justify-center mr-3 group-hover:bg-red-50 transition-colors">
                                                                <i
                                                                    class="ri-logout-box-line text-gray-400 group-hover:text-red-500"></i>
                                                            </div>
                                                            <span
                                                                class="text-xs font-bold text-gray-700 group-hover:text-red-500">중도
                                                                해지</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- Empty State -->
                    <template x-if="contracts.length === 0">
                        <div class="bg-white rounded-3xl border-2 border-dashed border-gray-100 py-24 text-center">
                            <div
                                class="w-24 h-24 bg-gray-50 rounded-3xl flex items-center justify-center mx-auto mb-8 rotate-3">
                                <i class="ri-folder-open-line text-5xl text-gray-200"></i>
                            </div>
                            <h3 class="text-2xl font-black text-gray-900 mb-3">진행 중인 계약이 없습니다</h3>
                            <p class="text-gray-400 font-medium max-w-sm mx-auto mb-10 leading-relaxed">이룸스튜디오에서 당신만을 위한
                                프리미엄 쉐어하우스 라이프를 시작해보세요.</p>
                            <a href="/"
                                class="inline-flex items-center px-10 py-4 bg-primary text-white font-black rounded-2xl shadow-xl shadow-primary/20 hover:scale-105 transition-all">
                                지금 바로 룸 찾아보기 <i class="ri-arrow-right-line ml-2"></i>
                            </a>
                        </div>
                    </template>
                </div>

                <!-- Service Requests Tab Content -->
                <div x-show="activeTab === 'requests'" class="animate-in fade-in slide-in-from-right-4 duration-500">
                    <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="px-8 py-6 border-b border-gray-50 flex items-center justify-between">
                            <h3 class="font-extrabold text-gray-900 text-lg">서비스 요청 내역</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50/50">
                                    <tr>
                                        <th
                                            class="px-8 py-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest">
                                            유형</th>
                                        <th
                                            class="px-8 py-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest">
                                            내용</th>
                                        <th
                                            class="px-8 py-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest">
                                            날짜</th>
                                        <th
                                            class="px-8 py-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest text-center">
                                            상태</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <template x-for="req in serviceRequests" :key="req.id">
                                        <tr class="hover:bg-gray-50/50 transition-all cursor-default">
                                            <td class="px-8 py-5">
                                                <span
                                                    class="inline-flex items-center bg-gray-50 text-gray-600 text-[10px] font-bold px-2.5 py-1 rounded-lg border border-gray-100 uppercase tracking-wider"
                                                    x-text="translateRequestType(req.type)"></span>
                                            </td>
                                            <td class="px-8 py-5">
                                                <p class="text-sm font-bold text-gray-800 line-clamp-1"
                                                    x-text="getRequestMessage(req.details)"></p>
                                            </td>
                                            <td class="px-8 py-5 text-[13px] text-gray-400 font-medium"
                                                x-text="formatDateShort(req.created_at)"></td>
                                            <td class="px-8 py-5 text-center">
                                                <span
                                                    :class="req.status === 'done' ? 'bg-green-50 text-green-600 border-green-100' : 'bg-amber-50 text-amber-600 border-amber-100'"
                                                    class="px-3 py-1 rounded-lg text-[10px] font-black border uppercase tracking-wider"
                                                    x-text="req.status === 'done' ? '완료' : '처리 중'"></span>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                            <template x-if="serviceRequests.length === 0">
                                <div class="py-24 text-center">
                                    <div
                                        class="w-16 h-16 bg-gray-50 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                        <i class="ri-tools-line text-3xl text-gray-200"></i>
                                    </div>
                                    <p class="text-gray-400 font-bold text-sm">서비스 요청 내역이 존재하지 않습니다.</p>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Inquiries Tab Content -->
                <div x-show="activeTab === 'inquiries'" class="animate-in fade-in slide-in-from-right-4 duration-500">
                    <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="px-8 py-6 border-b border-gray-50 flex items-center justify-between">
                            <h3 class="font-extrabold text-gray-900 text-lg">나의 문의 내역</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50/50">
                                    <tr>
                                        <th
                                            class="px-8 py-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest">
                                            대상</th>
                                        <th
                                            class="px-8 py-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest">
                                            내용</th>
                                        <th
                                            class="px-8 py-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest text-center">
                                            상태</th>
                                        <th
                                            class="px-8 py-4 text-[11px] font-bold text-gray-400 uppercase tracking-widest text-right">
                                            일시</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <template x-for="inq in inquiries" :key="inq.id">
                                        <tr class="hover:bg-gray-50/50 transition-all cursor-default">
                                            <td class="px-8 py-5">
                                                <span class="text-xs font-bold text-gray-900"
                                                    x-text="(inq.details.branch_name || '') + ' ' + (inq.details.room_name || '')"></span>
                                            </td>
                                            <td class="px-8 py-5">
                                                <p class="text-sm font-bold text-gray-600 line-clamp-1 max-w-md"
                                                    x-text="getRequestMessage(inq.details)"></p>
                                            </td>
                                            <td class="px-8 py-5 text-center">
                                                <span :class="{
                                                    'text-amber-600 bg-amber-50 border-amber-100': inq.status === 'submitted',
                                                    'text-blue-600 bg-blue-50 border-blue-100': inq.status === 'processing',
                                                    'text-green-600 bg-green-50 border-green-100': inq.status === 'done'
                                                }" class="px-3 py-1 rounded-lg text-[10px] font-black border uppercase shadow-sm"
                                                    x-text="inq.status === 'submitted' ? '접수완료' : (inq.status === 'processing' ? '답변중' : '답변완료')"></span>
                                            </td>
                                            <td class="px-8 py-5 text-right">
                                                <span class="text-xs font-medium text-gray-400"
                                                    x-text="formatDateShort(inq.created_at)"></span>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                            <template x-if="inquiries.length === 0">
                                <div class="py-24 text-center">
                                    <div
                                        class="w-16 h-16 bg-gray-50 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                        <i class="ri-chat-3-line text-3xl text-gray-200"></i>
                                    </div>
                                    <p class="text-gray-400 font-bold text-sm">문의 내역이 존재하지 않습니다.</p>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Profile Management Tab Content -->
                <div x-show="activeTab === 'profile'" class="animate-in fade-in slide-in-from-right-4 duration-500">
                    <div class="space-y-6">
                        <!-- Profile Info Card -->
                        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                            <div class="px-8 py-6 border-b border-gray-50">
                                <h3 class="font-extrabold text-gray-900 text-lg">기본 정보 수정</h3>
                                <p class="text-xs text-gray-400 mt-1">이름과 이메일 주소를 변경할 수 있습니다.</p>
                            </div>
                            <div class="p-8 space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="space-y-2">
                                        <label
                                            class="text-[11px] font-black text-gray-400 uppercase tracking-widest pl-1">이름</label>
                                        <input type="text" x-model="profileForm.name"
                                            class="w-full px-5 py-4 bg-gray-50 border border-gray-100 rounded-2xl text-gray-900 font-bold focus:outline-none focus:ring-4 focus:ring-primary/10 focus:border-primary focus:bg-white transition-all">
                                    </div>
                                    <div class="space-y-2">
                                        <label
                                            class="text-[11px] font-black text-gray-400 uppercase tracking-widest pl-1">이메일</label>
                                        <input type="email" x-model="profileForm.email"
                                            class="w-full px-5 py-4 bg-gray-50 border border-gray-100 rounded-2xl text-gray-900 font-bold focus:outline-none focus:ring-4 focus:ring-primary/10 focus:border-primary focus:bg-white transition-all">
                                    </div>
                                    <div class="space-y-2">
                                        <label
                                            class="text-[11px] font-black text-gray-400 uppercase tracking-widest pl-1">전화번호</label>
                                        <input type="tel" x-model="profileForm.phone" placeholder="예: 01012345678"
                                            class="w-full px-5 py-4 bg-gray-50 border border-gray-100 rounded-2xl text-gray-900 font-bold focus:outline-none focus:ring-4 focus:ring-primary/10 focus:border-primary focus:bg-white transition-all">
                                    </div>
                                </div>
                                <div class="flex justify-end pt-4">
                                    <button @click="updateProfileInfo()" :disabled="updatingProfile"
                                        class="px-8 py-4 bg-gray-900 text-white font-black rounded-2xl shadow-xl hover:scale-105 transition-all disabled:opacity-50 flex items-center">
                                        <span x-show="!updatingProfile">기본 정보 저장</span>
                                        <i x-show="updatingProfile" class="ri-loader-4-line animate-spin ml-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Password Change Card -->
                        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                            <div class="px-8 py-6 border-b border-gray-50">
                                <h3 class="font-extrabold text-gray-900 text-lg">비밀번호 변경</h3>
                                <p class="text-xs text-gray-400 mt-1">보안을 위해 주기적으로 비밀번호를 변경하는 것을 권장합니다.</p>
                            </div>
                            <div class="p-8 space-y-6">
                                <div class="space-y-6 max-w-md">
                                    <div class="space-y-2">
                                        <label
                                            class="text-[11px] font-black text-gray-400 uppercase tracking-widest pl-1">현재
                                            비밀번호</label>
                                        <input type="password" x-model="passwordForm.current"
                                            placeholder="현재 비밀번호를 입력하세요"
                                            class="w-full px-5 py-4 bg-gray-50 border border-gray-100 rounded-2xl text-gray-900 font-bold focus:outline-none focus:ring-4 focus:ring-primary/10 focus:border-primary focus:bg-white transition-all">
                                    </div>
                                    <div class="space-y-2">
                                        <label
                                            class="text-[11px] font-black text-gray-400 uppercase tracking-widest pl-1">새
                                            비밀번호</label>
                                        <input type="password" x-model="passwordForm.new" placeholder="새 비밀번호를 입력하세요"
                                            class="w-full px-5 py-4 bg-gray-50 border border-gray-100 rounded-2xl text-gray-900 font-bold focus:outline-none focus:ring-4 focus:ring-primary/10 focus:border-primary focus:bg-white transition-all">
                                    </div>
                                    <div class="space-y-2">
                                        <label
                                            class="text-[11px] font-black text-gray-400 uppercase tracking-widest pl-1">새
                                            비밀번호 확인</label>
                                        <input type="password" x-model="passwordForm.confirm"
                                            placeholder="새 비밀번호를 한 번 더 입력하세요"
                                            class="w-full px-5 py-4 bg-gray-50 border border-gray-100 rounded-2xl text-gray-900 font-bold focus:outline-none focus:ring-4 focus:ring-primary/10 focus:border-primary focus:bg-white transition-all">
                                    </div>
                                </div>
                                <div class="flex justify-end pt-4">
                                    <button @click="updatePassword()" :disabled="updatingPassword"
                                        class="px-8 py-4 bg-primary text-white font-black rounded-2xl shadow-xl shadow-primary/20 hover:scale-105 transition-all disabled:opacity-50 flex items-center">
                                        <span x-show="!updatingPassword">비밀번호 변경하기</span>
                                        <i x-show="updatingPassword" class="ri-loader-4-line animate-spin ml-2"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Service Request Modal -->
    <div x-show="serviceModalOpen" class="fixed inset-0 z-50 overflow-y-auto" x-cloak
        x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-black/50 backdrop-blur-sm"
                @click="serviceModalOpen = false">
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div class="inline-block overflow-hidden text-left align-bottom transition-all transform bg-white rounded-3xl shadow-2xl sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100">

                <!-- Modal Header -->
                <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center text-white mr-4 shadow-lg"
                            :class="{
                                'bg-blue-500 shadow-blue-500/20': selectedServiceType === 'repair',
                                'bg-purple-500 shadow-purple-500/20': selectedServiceType === 'supplies',
                                'bg-green-500 shadow-green-500/20': selectedServiceType === 'extension',
                                'bg-red-500 shadow-red-500/20': selectedServiceType === 'termination'
                            }">
                            <i :class="{
                                'ri-tools-line': selectedServiceType === 'repair',
                                'ri-sparkling-2-line': selectedServiceType === 'supplies',
                                'ri-calendar-event-line': selectedServiceType === 'extension',
                                'ri-logout-box-line': selectedServiceType === 'termination'
                            }" class="text-xl"></i>
                        </div>
                        <h3 class="text-xl font-black text-gray-900" x-text="translateRequestType(selectedServiceType)">
                        </h3>
                    </div>
                    <button @click="serviceModalOpen = false"
                        class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="ri-close-line text-2xl"></i>
                    </button>
                </div>

                <!-- Modal Content -->
                <div class="px-8 py-8 space-y-6">
                    <div x-show="selectedServiceType !== 'extension'">
                        <label class="block text-[11px] font-black text-gray-400 uppercase tracking-widest mb-3">
                            <span x-show="selectedServiceType === 'repair'">고장 내용 및 위치</span>
                            <span x-show="selectedServiceType === 'supplies'">요청 항목 (비품명, 청소 요청 등)</span>
                            <span x-show="selectedServiceType === 'termination'">퇴실 예정일 및 사유</span>
                        </label>
                        <textarea x-model="serviceFormData.message" rows="4"
                            class="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-2xl text-gray-900 font-medium placeholder:text-gray-300 focus:outline-none focus:ring-4 focus:ring-primary/10 focus:border-primary focus:bg-white transition-all resize-none"
                            :placeholder="getServicePlaceholder()"></textarea>
                    </div>

                    <!-- Extension Structured UI -->
                    <div x-show="selectedServiceType === 'extension'" class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-primary/5 rounded-2xl p-5 border border-primary/10">
                                <p class="text-[11px] font-bold text-primary uppercase tracking-widest mb-1">현재 종료일</p>
                                <p class="text-xl font-black text-gray-900" x-text="selectedContractEndDate"></p>
                            </div>
                            <div class="bg-green-50 rounded-2xl p-5 border border-green-100">
                                <p class="text-[11px] font-bold text-green-600 uppercase tracking-widest mb-1">예정 종료일
                                </p>
                                <p class="text-xl font-black text-gray-900" x-text="newEndDate"></p>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <label class="block text-[11px] font-black text-gray-400 uppercase tracking-widest pl-1">추가할
                                개월 수</label>
                            <select x-model="serviceFormData.extensionMonths"
                                class="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-2xl text-gray-900 font-bold focus:outline-none focus:ring-4 focus:ring-primary/10 focus:border-primary focus:bg-white transition-all appearance-none">
                                <option value="1">1개월 추가</option>
                                <option value="2">2개월 추가</option>
                                <option value="3">3개월 추가</option>
                                <option value="4">4개월 추가</option>
                                <option value="5">5개월 추가</option>
                                <option value="6">6개월 추가</option>
                                <option value="12">12개월(1년) 추가</option>
                            </select>
                        </div>

                        <div class="space-y-3">
                            <label class="block text-[11px] font-black text-gray-400 uppercase tracking-widest pl-1">기타
                                요청사항 (선택)</label>
                            <textarea x-model="serviceFormData.message" rows="2"
                                class="w-full px-5 py-4 bg-gray-50 border border-gray-200 rounded-2xl text-gray-900 font-medium placeholder:text-gray-300 focus:outline-none focus:ring-4 focus:ring-primary/10 focus:border-primary focus:bg-white transition-all resize-none"
                                placeholder="관리자에게 전달할 추가 메시지가 있다면 입력해주세요."></textarea>
                        </div>
                    </div>

                    <div class="bg-gray-50/80 rounded-2xl p-4 border border-gray-100">
                        <p class="text-[10px] font-bold text-gray-500 leading-relaxed">
                            <i class="ri-information-line mr-1"></i>
                            영업시간(평일 09:00 - 18:00) 외 접수된 건은 다음 영업일에 순차적으로 처리됩니다. 긴급한 경우 관리자에게 직접 연락 부탁드립니다.
                        </p>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="px-8 py-6 bg-gray-50/50 flex justify-end items-center gap-3">
                    <button @click="serviceModalOpen = false"
                        class="px-6 py-3 text-sm font-bold text-gray-500 hover:text-gray-700 transition-colors">취소</button>
                    <button @click="submitServiceRequest()"
                        :disabled="submittingService || (selectedServiceType !== 'extension' && !serviceFormData.message)"
                        class="px-10 py-3 text-white text-sm font-black rounded-xl shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center"
                        :class="{
                            'bg-blue-600 shadow-blue-600/20': selectedServiceType === 'repair',
                            'bg-purple-600 shadow-purple-600/20': selectedServiceType === 'supplies',
                            'bg-green-600 shadow-green-600/20': selectedServiceType === 'extension',
                            'bg-red-600 shadow-red-600/20': selectedServiceType === 'termination'
                        }">
                        <template x-if="!submittingService">
                            <span>요청 보내기</span>
                        </template>
                        <i x-show="submittingService" class="ri-loader-4-line animate-spin text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    function dashboardData() {
        return {
            activeTab: 'dashboard',
            loading: true,
            userName: '',
            contracts: [],
            requests: [],

            // Service Modal State
            serviceModalOpen: false,
            selectedServiceType: '',
            selectedContractId: null,
            submittingService: false,
            serviceFormData: {
                message: '',
                extensionMonths: '1'
            },
            selectedContractEndDate: '',

            get newEndDate() {
                if (this.selectedServiceType !== 'extension' || !this.selectedContractId) return '';
                const contract = this.contracts.find(c => c.id === this.selectedContractId);
                if (!contract) return '';

                const d = new Date(contract.end_date);
                d.setMonth(d.getMonth() + parseInt(this.serviceFormData.extensionMonths));
                return this.formatDateShort(d);
            },

            // Profile Management State
            updatingProfile: false,
            updatingPassword: false,
            profileForm: {
                name: '',
                email: '',
                phone: ''
            },
            passwordForm: {
                current: '',
                new: '',
                confirm: ''
            },

            async init() {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login';
                    return;
                }

                try {
                    // Fetch User Info
                    const userRes = await fetch('/api/auth/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (userRes.ok) {
                        const userData = await userRes.json();
                        this.userName = userData.name;

                        // Initialize Profile Form
                        this.profileForm.name = this.userName;
                        this.profileForm.email = userData.email;
                        this.profileForm.phone = userData.phone || '';
                    }

                    // Fetch Contracts
                    const contractRes = await fetch('/api/contracts', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (contractRes.ok) {
                        this.contracts = await contractRes.json();
                    }

                    // Fetch Requests
                    await this.loadRequests();

                } catch (error) {
                    console.error('Error fetching dashboard data:', error);
                } finally {
                    this.loading = false;
                }
            },

            async loadRequests() {
                const token = localStorage.getItem('token');
                if (!token) return;
                try {
                    const requestRes = await fetch('/api/requests', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (requestRes.ok) {
                        this.requests = await requestRes.json();
                    }
                } catch (e) {
                    console.error('Error loading requests:', e);
                }
            },

            get serviceRequests() {
                return this.requests.filter(r => r.type !== 'inquiry');
            },

            get inquiries() {
                return this.requests.filter(r => r.type === 'inquiry');
            },

            openServiceModal(type, contractId) {
                this.selectedServiceType = type;
                this.selectedContractId = contractId;
                this.serviceFormData.message = '';
                this.serviceFormData.extensionMonths = '1';

                // Find contract info for extension
                if (type === 'extension') {
                    const contract = this.contracts.find(c => c.id === contractId);
                    if (contract) {
                        this.selectedContractEndDate = this.formatDateShort(contract.end_date);
                    }
                }

                this.serviceModalOpen = true;
            },

            getServicePlaceholder() {
                switch (this.selectedServiceType) {
                    case 'repair': return '예: 세면대 배수구가 막혔어요. 문잠금 장치가 뻑뻑합니다.';
                    case 'supplies': return '예: 20L 종량제 봉투 2장 요청합니다. / 방 정기 청소 요청합니다.';
                    case 'extension': return '예: 계약을 3개월 더 연장하고 싶습니다.';
                    case 'termination': return '예: 개인 사정으로 인해 XX월 XX일에 퇴실하고자 합니다.';
                    default: return '내용을 입력해주세요.';
                }
            },

            async submitServiceRequest() {
                if (!this.serviceFormData.message.trim()) return;

                this.submittingService = true;
                const token = localStorage.getItem('token');

                try {
                    const response = await fetch('/api/requests', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            type: this.selectedServiceType,
                            contract_id: this.selectedContractId,
                            details: {
                                message: this.serviceFormData.message,
                                extension_months: this.selectedServiceType === 'extension' ? parseInt(this.serviceFormData.extensionMonths) : null
                            }
                        })
                    });

                    if (response.ok) {
                        this.serviceModalOpen = false;
                        await this.loadRequests();
                        window.showAlert?.('성공', '요청이 성공적으로 접수되었습니다.', 'success');
                    } else {
                        const data = await response.json();
                        window.showAlert?.('실패', data.message || '요청 제출에 실패했습니다.', 'error');
                    }
                } catch (error) {
                    console.error('Error submitting request:', error);
                    window.showAlert?.('오류', '오류가 발생했습니다. 잠시 후 다시 시도해주세요.', 'error');
                } finally {
                    this.submittingService = false;
                }
            },

            translateStatus(status) {
                const map = {
                    'requested': '승인 대기 중',
                    'active': '이용 중',
                    'completed': '계약 종료',
                    'terminated': '계약 종료',
                    'terminate_requested': '해지 요청 중',
                    'cancelled': '취소됨'
                };
                return map[status] || status;
            },

            getStatusBadgeClass(status) {
                switch (status) {
                    case 'active': return 'bg-green-50 text-green-700 border border-green-100';
                    case 'requested': return 'bg-amber-50 text-amber-700 border border-amber-100';
                    case 'terminate_requested': return 'bg-amber-50 text-amber-700 border border-amber-100';
                    case 'terminated': return 'bg-gray-50 text-gray-500 border border-gray-100';
                    case 'completed': return 'bg-gray-50 text-gray-500 border border-gray-100';
                    case 'cancelled': return 'bg-red-50 text-red-700 border border-red-100';
                    default: return 'bg-gray-50 text-gray-500 border border-gray-100';
                }
            },

            formatDate(dateStr) {
                if (!dateStr) return '';
                return new Date(dateStr).toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            },

            formatDateShort(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                return `${d.getFullYear()}.${String(d.getMonth() + 1).padStart(2, '0')}.${String(d.getDate()).padStart(2, '0')}`;
            },

            translateRequestType(type) {
                const map = {
                    'inquiry': '상담 문의',
                    'repair': '시설 수리',
                    'supplies': '비품 요청',
                    'extension': '연장 신청',
                    'termination': '중도 해지'
                };
                return map[type] || type;
            },

            getRequestMessage(details) {
                if (!details) return '내용 없음';
                if (typeof details === 'string') return details;
                return details.message || details.content || JSON.stringify(details);
            },

            // Profile Management Methods
            async updateProfileInfo() {
                if (!this.profileForm.name.trim() || !this.profileForm.email.trim()) {
                    window.showAlert?.('경고', '이름과 이메일을 모두 입력해주세요.', 'warning');
                    return;
                }

                this.updatingProfile = true;
                const token = localStorage.getItem('token');

                try {
                    const response = await fetch('/api/auth/profile', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            name: this.profileForm.name,
                            email: this.profileForm.email,
                            phone: this.profileForm.phone
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.userName = data.user.name;
                        window.showAlert?.('성공', '회원 정보가 수정되었습니다.', 'success');
                    } else {
                        window.showAlert?.('실패', data.message || '정보 수정에 실패했습니다.', 'error');
                    }
                } catch (error) {
                    console.error('Error updating profile:', error);
                    window.showAlert?.('오류', '오류가 발생했습니다. 잠시 후 다시 시도해주세요.', 'error');
                } finally {
                    this.updatingProfile = false;
                }
            },

            async updatePassword() {
                if (!this.passwordForm.current || !this.passwordForm.new || !this.passwordForm.confirm) {
                    window.showAlert?.('경고', '모든 필드를 입력해주세요.', 'warning');
                    return;
                }

                if (this.passwordForm.new !== this.passwordForm.confirm) {
                    window.showAlert?.('경고', '새 비밀번호가 일치하지 않습니다.', 'warning');
                    return;
                }

                this.updatingPassword = true;
                const token = localStorage.getItem('token');

                try {
                    const response = await fetch('/api/auth/profile', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            current_password: this.passwordForm.current,
                            new_password: this.passwordForm.new
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.passwordForm = { current: '', new: '', confirm: '' };
                        window.showAlert?.('성공', '비밀번호가 변경되었습니다.', 'success');
                    } else {
                        window.showAlert?.('실패', data.message || '비밀번호 변경에 실패했습니다.', 'error');
                    }
                } catch (error) {
                    console.error('Error updating password:', error);
                    window.showAlert?.('오류', '오류가 발생했습니다. 잠시 후 다시 시도해주세요.', 'error');
                } finally {
                    this.updatingPassword = false;
                }
            }
        }
    }
</script>
<style>
    [x-cloak] {
        display: none !important;
    }

    /* Smooth transition for active menu items */
    .animate-in {
        animation-duration: 400ms;
        animation-fill-mode: both;
    }

    .fade-in {
        opacity: 0;
        animation-name: fadeIn;
    }

    .slide-in-from-right-4 {
        transform: translateX(1rem);
        animation-name: slideInFromRight;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideInFromRight {
        from {
            transform: translateX(1rem);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}
{% endblock %}