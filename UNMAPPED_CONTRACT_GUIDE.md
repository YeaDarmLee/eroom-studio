# ë¯¸ë§¤í•‘ ê³„ì•½ ì‹œìŠ¤í…œ ì‚¬ìš© ê°€ì´ë“œ

## ğŸ“Œ ê°œìš”

ëŸ°ì¹­ ì „ì— ê¸°ì¡´ ê³„ì•½ì¤‘ì¸ ë°©ì˜ ë°ì´í„°ë¥¼ ë¨¼ì € ì…ë ¥í•˜ê³ , ë‚˜ì¤‘ì— ì‚¬ìš©ìê°€ íšŒì›ê°€ì…í•˜ë©´ ìë™ìœ¼ë¡œ ë§¤í•‘ë˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

## ğŸ”§ ì‹œìŠ¤í…œ êµ¬ì„±

### 1. **ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½ì‚¬í•­**

#### Contract í…Œì´ë¸”
- `user_id`: nullableë¡œ ë³€ê²½ (ë¯¸ë§¤í•‘ ê³„ì•½ í—ˆìš©)
- `temp_user_name`: ì„ì‹œ ì‚¬ìš©ì ì´ë¦„
- `temp_user_phone`: ì„ì‹œ ì‚¬ìš©ì ì „í™”ë²ˆí˜¸ â­ **ë§¤í•‘ í‚¤**
- `temp_user_email`: ì„ì‹œ ì‚¬ìš©ì ì´ë©”ì¼

#### User í…Œì´ë¸”
- `phone`: ì „í™”ë²ˆí˜¸ ì»¬ëŸ¼ ì¶”ê°€ (unique)

### 2. **í•µì‹¬ ë©”ì»¤ë‹ˆì¦˜**

**ë§¤í•‘ í”„ë¡œì„¸ìŠ¤:**
```
1. ê´€ë¦¬ìê°€ ë¯¸ë§¤í•‘ ê³„ì•½ ìƒì„± (user_id = NULL)
   â””â”€> temp_user_phoneì— ê³„ì•½ì ì „í™”ë²ˆí˜¸ ì €ì¥

2. ê³„ì•½ìê°€ íšŒì›ê°€ì…
   â””â”€> ì „í™”ë²ˆí˜¸ ì…ë ¥

3. ìë™ ë§¤í•‘ ì‹¤í–‰
   â””â”€> Contract.temp_user_phone == User.phone
   â””â”€> Contract.user_id = User.id
```

## ğŸ“ ì‚¬ìš© ë°©ë²•

### **Step 1: ë¯¸ë§¤í•‘ ê³„ì•½ ìƒì„±**

ê´€ë¦¬ìê°€ ê³„ì•½ ì •ë³´ë¥¼ ë¯¸ë¦¬ ì…ë ¥í•©ë‹ˆë‹¤.

**API ì—”ë“œí¬ì¸íŠ¸:**
```
POST /admin/api/contracts/unmapped
```

**ìš”ì²­ ì˜ˆì‹œ:**
```json
{
  "room_id": 5,
  "temp_user_name": "í™ê¸¸ë™",
  "temp_user_phone": "010-1234-5678",  // í•„ìˆ˜ - ë§¤í•‘ í‚¤
  "temp_user_email": "hong@example.com",
  "start_date": "2026-01-15",
  "end_date": "2026-12-15",
  "status": "active",
  "months": 12,
  "total_price": 6000000
}
```

**ì‘ë‹µ:**
```json
{
  "message": "ë¯¸ë§¤í•‘ ê³„ì•½ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤",
  "id": 123,
  "temp_user_phone": "010-1234-5678"
}
```

---

### **Step 2: ë¯¸ë§¤í•‘ ê³„ì•½ ì¡°íšŒ**

ìƒì„±ëœ ë¯¸ë§¤í•‘ ê³„ì•½ ëª©ë¡ì„ í™•ì¸í•©ë‹ˆë‹¤.

**API ì—”ë“œí¬ì¸íŠ¸:**
```
GET /admin/api/contracts/unmapped
```

**ì‘ë‹µ ì˜ˆì‹œ:**
```json
[
  {
    "id": 123,
    "temp_user_name": "í™ê¸¸ë™",
    "temp_user_phone": "010-1234-5678",
    "temp_user_email": "hong@example.com",
    "room_name": "101í˜¸",
    "branch_name": "ê°•ë‚¨ì ",
    "deposit": 1000000,
    "price": 500000,
    "start_date": "2026-01-15",
    "end_date": "2026-12-15",
    "status": "active",
    "created_at": "2026-01-06 09:30"
  }
]
```

---

### **Step 3: ìë™ ë§¤í•‘ (íšŒì›ê°€ì… ì‹œ)**

ì‚¬ìš©ìê°€ íšŒì›ê°€ì…í•˜ë©´ **ìë™ìœ¼ë¡œ** ë§¤í•‘ë©ë‹ˆë‹¤.

**ìë™ ë§¤í•‘ ì¡°ê±´:**
- User.phone == Contract.temp_user_phone
- ë˜ëŠ” User.email == Contract.temp_user_email

**ë§¤í•‘ ë¡œì§:**
```python
# app/services/auth_service.py
# get_or_create_kakao_user() ë©”ì„œë“œì—ì„œ ìë™ ì‹¤í–‰

if ìƒˆ_ì‚¬ìš©ì_ìƒì„±:
    ContractMappingService.map_contracts_to_user(user)
    # ì „í™”ë²ˆí˜¸ë‚˜ ì´ë©”ì¼ì´ ì¼ì¹˜í•˜ëŠ” ë¯¸ë§¤í•‘ ê³„ì•½ì„ ìë™ìœ¼ë¡œ ì°¾ì•„ì„œ ë§¤í•‘
```

---

### **Step 4: ìˆ˜ë™ ë§¤í•‘ (í•„ìš”ì‹œ)**

ìë™ ë§¤í•‘ì´ ì•ˆ ëœ ê²½ìš°, ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ ë§¤í•‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### 4-1. ë§¤í•‘ ê°€ëŠ¥í•œ ì‚¬ìš©ì ê²€ìƒ‰

**API ì—”ë“œí¬ì¸íŠ¸:**
```
GET /admin/api/contracts/{contract_id}/search-user
```

**ì‘ë‹µ ì˜ˆì‹œ:**
```json
[
  {
    "id": 42,
    "name": "í™ê¸¸ë™",
    "email": "hong@example.com",
    "phone": "010-1234-5678",
    "created_at": "2026-01-07 10:00"
  }
]
```

#### 4-2. ìˆ˜ë™ ë§¤í•‘ ì‹¤í–‰

**API ì—”ë“œí¬ì¸íŠ¸:**
```
POST /admin/api/contracts/{contract_id}/map/{user_id}
```

**ì‘ë‹µ:**
```json
{
  "message": "ê³„ì•½ì´ ì„±ê³µì ìœ¼ë¡œ ë§¤í•‘ë˜ì—ˆìŠµë‹ˆë‹¤"
}
```

---

## ğŸ¯ ì‹¤ì „ ì˜ˆì‹œ

### **ì‹œë‚˜ë¦¬ì˜¤: ëŸ°ì¹­ ì „ 3ê°œì˜ ê³„ì•½ ë°ì´í„° ì…ë ¥**

#### 1ï¸âƒ£ ê³„ì•½ ë°ì´í„° ì…ë ¥

```bash
# ê³„ì•½ 1: í™ê¸¸ë™
curl -X POST https://your-domain.com/admin/api/contracts/unmapped \
  -H "Authorization: Bearer {admin_token}" \
  -H "Content-Type: application/json" \
  -d '{
    "room_id": 5,
    "temp_user_name": "í™ê¸¸ë™",
    "temp_user_phone": "010-1234-5678",
    "temp_user_email": "hong@example.com",
    "start_date": "2026-01-15",
    "end_date": "2026-12-15",
    "status": "active"
  }'

# ê³„ì•½ 2: ê¹€ì² ìˆ˜
curl -X POST https://your-domain.com/admin/api/contracts/unmapped \
  ... (ë™ì¼í•œ ë°©ì‹)

# ê³„ì•½ 3: ì´ì˜í¬
curl -X POST https://your-domain.com/admin/api/contracts/unmapped \
  ... (ë™ì¼í•œ ë°©ì‹)
```

#### 2ï¸âƒ£ ì‚¬ìš©ì íšŒì›ê°€ì…

```
í™ê¸¸ë™ë‹˜ì´ íšŒì›ê°€ì…:
- ì „í™”ë²ˆí˜¸: 010-1234-5678 ì…ë ¥
- ìë™ìœ¼ë¡œ ê³„ì•½ 1ì´ ë§¤í•‘ë¨! âœ…
```

#### 3ï¸âƒ£ ë§¤í•‘ í™•ì¸

```bash
# ì „ì²´ ê³„ì•½ ì¡°íšŒ (ë§¤í•‘/ë¯¸ë§¤í•‘ ëª¨ë‘ í‘œì‹œ)
GET /admin/api/contracts
```

**ì‘ë‹µ:**
```json
[
  {
    "id": 1,
    "user_name": "í™ê¸¸ë™",
    "user_phone": "010-1234-5678",
    "is_mapped": true,  // âœ… ë§¤í•‘ ì™„ë£Œ
    ...
  },
  {
    "id": 2,
    "user_name": "ê¹€ì² ìˆ˜",
    "user_phone": "010-9876-5432",
    "is_mapped": false,  // â³ ëŒ€ê¸° ì¤‘
    ...
  },
  {
    "id": 3,
    "user_name": "ì´ì˜í¬",
    "user_phone": "010-5555-1234",
    "is_mapped": false,  // â³ ëŒ€ê¸° ì¤‘
    ...
  }
]
```

---

## ğŸ” ì£¼ìš” í•„ë“œ ì„¤ëª…

| í•„ë“œ | ì„¤ëª… | í•„ìˆ˜ ì—¬ë¶€ |
|------|------|-----------|
| `room_id` | ë°© ID | âœ… í•„ìˆ˜ |
| `temp_user_phone` | ê³„ì•½ì ì „í™”ë²ˆí˜¸ (ë§¤í•‘ í‚¤) | âœ… í•„ìˆ˜ |
| `temp_user_name` | ê³„ì•½ì ì´ë¦„ | ì„ íƒ |
| `temp_user_email` | ê³„ì•½ì ì´ë©”ì¼ (ë§¤í•‘ í‚¤ë¡œë„ ì‚¬ìš©) | ì„ íƒ |
| `start_date` | ê³„ì•½ ì‹œì‘ì¼ | âœ… í•„ìˆ˜ |
| `end_date` | ê³„ì•½ ì¢…ë£Œì¼ | âœ… í•„ìˆ˜ |
| `status` | ê³„ì•½ ìƒíƒœ (ê¸°ë³¸ê°’: active) | ì„ íƒ |

---

## âš ï¸ ì¤‘ìš” ì‚¬í•­

1. **ì „í™”ë²ˆí˜¸ëŠ” ë§¤í•‘ì˜ í•µì‹¬ í‚¤ì…ë‹ˆë‹¤**
   - `temp_user_phone`ì„ ë°˜ë“œì‹œ ì •í™•í•˜ê²Œ ì…ë ¥í•˜ì„¸ìš”
   - í˜•ì‹: "010-1234-5678" ë˜ëŠ” "01012345678" (ì¼ê´€ì„± ìœ ì§€)

2. **ìë™ ë§¤í•‘ íƒ€ì´ë°**
   - íšŒì›ê°€ì… ì‹œ ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤
   - ë¡œê·¸ì—ì„œ ë§¤í•‘ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤

3. **ìˆ˜ë™ ë§¤í•‘**
   - ìë™ ë§¤í•‘ì´ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ ì‚¬ìš©í•˜ì„¸ìš”
   - `/search-user` APIë¡œ ë¨¼ì € í™•ì¸ í›„ ë§¤í•‘í•˜ì„¸ìš”

4. **ë°ì´í„° í™•ì¸**
   - ë¯¸ë§¤í•‘ ê³„ì•½: `GET /admin/api/contracts/unmapped`
   - ì „ì²´ ê³„ì•½: `GET /admin/api/contracts`
   - `is_mapped` í•„ë“œë¡œ ë§¤í•‘ ì—¬ë¶€ í™•ì¸ ê°€ëŠ¥

---

## ğŸ¬ ëŸ°ì¹­ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ í™•ì¸ (`python migrate_unmapped_contracts.py`)
- [ ] ëª¨ë“  ê¸°ì¡´ ê³„ì•½ ë°ì´í„° ì…ë ¥ ì™„ë£Œ
- [ ] ë¯¸ë§¤í•‘ ê³„ì•½ ëª©ë¡ í™•ì¸ (`GET /admin/api/contracts/unmapped`)
- [ ] ì „í™”ë²ˆí˜¸ í˜•ì‹ ì¼ê´€ì„± í™•ì¸
- [ ] í…ŒìŠ¤íŠ¸ ê³„ì •ìœ¼ë¡œ ìë™ ë§¤í•‘ í…ŒìŠ¤íŠ¸
- [ ] ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì—ì„œ ë¯¸ë§¤í•‘/ë§¤í•‘ ìƒíƒœ í™•ì¸

---

## ğŸ†˜ ë¬¸ì œ í•´ê²°

### ìë™ ë§¤í•‘ì´ ì•ˆ ë¼ìš”!

**ì›ì¸:**
- ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ë‹¤ë¦„ (ì˜ˆ: "010-1234-5678" vs "01012345678")
- ì „í™”ë²ˆí˜¸ ì˜¤íƒ€
- íšŒì›ê°€ì… ì‹œ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì§€ ì•ŠìŒ

**í•´ê²°:**
1. ì‚¬ìš©ì ì •ë³´ í™•ì¸: `GET /admin/api/contracts/{contract_id}/search-user`
2. ìˆ˜ë™ ë§¤í•‘: `POST /admin/api/contracts/{contract_id}/map/{user_id}`

### ë¯¸ë§¤í•‘ ê³„ì•½ì´ ì•ˆ ë³´ì—¬ìš”!

**í™•ì¸ ì‚¬í•­:**
- `Contract.user_id`ê°€ NULLì¸ì§€ í™•ì¸
- API ì—”ë“œí¬ì¸íŠ¸ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸ (`/admin/api/contracts/unmapped`)

---

## ğŸ“ ì§€ì›

ë¬¸ì œê°€ ë°œìƒí•˜ë©´ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:
1. ì„œë²„ ë¡œê·¸ (ìë™ ë§¤í•‘ ë©”ì‹œì§€ í™•ì¸)
2. DB í…Œì´ë¸” êµ¬ì¡° (`DESCRIBE contracts`, `DESCRIBE users`)
3. ì´ ê°€ì´ë“œì˜ "ë¬¸ì œ í•´ê²°" ì„¹ì…˜
